[{"content":"お疲れ様です！！(気さくな挨拶)\nこの記事は琉球大学知能情報アドベントカレンダー 2023 12/20日の参加記事です！\n12月も終盤戦、カラオケっぽいものを作ってみたという記事をお送りします\nTL;DR Next.js でカラオケみたいに音符が流れてくるやつを作った。これ AudioAnalyserをこねる Next.js をGitHub Pagesで静的デプロイするときのハマりポイントがある。 カラオケしたい みなさん、カラオケはお好きですか？ 私はたまに(occasionally)ヒトカラをしています。しないというみなさんも家で軽く歌ったりしますよね？\nそんなときに気になるのは今歌った音程はあっているのか…？ずっと鼻歌で歌っていても、YouTubeで音楽と一緒に歌っていても、カラオケに行くとまともに音程が取れないなんてこともザラにあります。\nとうことで、曲の音程と自分がいまだしている音程が知りたいわけです。\nつまり、カラオケを作りたいということですね。\nカラオケを作るには、いくつかの必須の機能があります。\n声の音程を判定できること 曲の音符(ノート)が表示されていること 音符がいい感じに流れること カラオケ(JoySoundとかDAMとか)は判定ぐらいしかしてくれませんが、せっかくですしFFTの結果をそのまま使っても面白そうですね。 ということで作っていきましょう！\nAudioAnalyserをこねこね 今回は練習ついでにNext.js (TS) を使用していきます。\nマイクの音声はこんな感じでとれます。\nconst stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, }, }); echoCancellationとnoiseSuppressionはあんまり見慣れませんが、見ての通りノイズ抑制とかを無効化しています。 これが有効だとうまく声が入らなかったりしたので…\nそして、JSにはなんと音声処理をできたりするAudioNodeインスタンスがあって、その中でも AnalyserNode (MDN)を使えば音声のFFTができます。\nAnalyserNodeの使い方を調べるとだいたい音楽データを流したりしていますがやっぱり声もやりたいですよね。 FFTした結果はこんな感じで取ることができます。\nconst fftSize = 8192; analyser.fftSize = fftSize; const bufferSize = analyser.frequencyBinCount; const sampleRate = audioContext.sampleRate; const buffer = new Uint8Array(bufferSize); // 結果が入るところ audioContext = new AudioContext(); analyser = audioContext.createAnalyser(); const input = audioContext.createMediaStreamSource(stream); input.connect(analyser); analyser.getByteFrequencyData(buffer); これでいい感じに周波数情報が取れたわけですが、これをビジュアライズするにはひと工夫必要です。 なんと、愚直にグラフ化すると、直感的なグラフにならないんですね～。\n音程の周波数の差は高周波数の方ほど大きくなっていくので、思ったより変なグラフができます。\nそのため、周波数側をlogスケールの片対数グラフにするといい感じに直感的なグラフができます。 この画像は下の方が低周波数、上に行くほど高周波数になるやつです。\nピッチを取りたい 周波数は取れたわけですが、ピッチ(音高)も取りたいです。なんでかというと、音高がないとどの周波数を音程として判定したらいいかわからなくなるからですね。\n(今のところ判定はないんですが)\nピッチの判定とかで軽くググると機械学習を応用するーーとか書いてあるんですがそこまでの精度もいらないですし静的にデプロイできなさそうなので嫌です。JS(TS)でできるぐらいで十分なんです。\n結局、周波数のピーク(山)を検出して、倍音を持っている山\u0026rsquo;sのうち低いものの周波数をピッチとして表示しています。\n声からもn倍音が出ているのでそれを手がかりにピッチを取っているわけです。\nUSTをこねこね 話は変わって、カラオケみたいなやつには音符を表示できる必要があります。カラオケに行けばノーツが表示されるアレです。\nアレを作るには、まず使うデータを考えないといけません。音程の情報があって、ノーツの長さがあって、テンポの情報があって…そんなファイルを読み込めたら一番うれしいですね。\nさて、ボーカロイド(広義)はそういうデータを扱っているはずですね。歌声合成ソフトには音程もノーツ長もテンポも必須です。\n歌声合成ソフトは割りといっぱいって、フリーのUTAU,neutrino ,Synthesizer V Studio Basic(ボイスは有料) ,有料ならVOCALOID, Synthesizer V Studio Pro, Cevio AI\u0026hellip; いっぱいあります。\n保存形式としては、MIDIやUSTファイル,vsqファイルとかがあるみたいでした。そのなかでパースが楽そうな保存ファイルとして、UTAUの.ustファイルを使うことにしました。なんでかというとUTAUはUSTを公開してくれている人が多かったり、平文で保存されていて、扱いやすそうだったからです。\nUSTファイルの構成は@wikiにまとめてくれている方がました。大感謝！\n使うのはとりあえずテンポと音階(MIDI Note番号),ノートの長さ が必要なのでひとまずそれを読むパーサを書いて使います。\nこれをいい感じにCanvasに描画するとそれっぽい感じのグラフができました！！ (表示のUSTはsm6752330で配布されているものをお借りしました)\nひとまず完成 とりあえず今できた部分を完成として出してしまいます。 ホントはノーツが表示範囲外になったらいい感じにずらすとか、一時停止できたりとかの機能がほしいところですが…\nZuckerbergがdone is better than perfectとか言っている有名な画像もあることですしね。\nNext.js -\u0026gt; GitHubPages ハマりポイント やったー！完成だーー！といってGitHubPagesへデプロイして動作確認したら動かない！！Canvasが描画されてない！！\n困りましたね。\nConsoleにはスクリプトの404エラーが書いてありました。\nうーーん？見覚えがありますね？ HugoをGitHubPagesへ持っていったときにも見た記憶があります。そうです、ページのパスがサブディレクトリになっているときにルートへ読みに行って404を吐いてきていました。\nということで next.config.js へ次の設定を追加します\nbasePath: \u0026quot;/karaoke\u0026quot;, assetPrefix: \u0026quot;/karaoke/\u0026quot;, これで正しいパスへ読みに行ってくれるようになりました！ ……あれー？まだ404です。パスはあっているんですが…\n解決策を求めてネットの海をさまよったところ見つけました。みんなの味方StackOverflowにありました！\njs and css not loading when hosting next application on GitHub pages\nドキュメントのルートに.nojekyll という名前の空ファイルを置いておかないとGitHubがデプロイしてくれないそうですね！\nこれをつけることでやっと公開できました！めでたしめでたし\nこれで今日の記事は終わりです。 明日は 琉大つよつよ勢代表 @Yoshisaur さんの記事です お楽しみに！\n","date":"2023-12-19","permalink":"https://medicine-t.github.io/medicine-t/post/advent2023-12-20/","tags":["琉大","ie","advent2023"],"title":"カラオケを作りたーーーーい！"},{"content":"この記事は琉大ieアドベントカレンダー 12/4の記事です。\n私事ですが、12/4は私の誕生日です。 20歳になりました。\n今日の内容 今年やってみたことを振り返ります。\n参加したイベントだったり、新しく始めたことだったり、そういったことを共有していきたい。\nイベント ハッカソンだったりコンテスト系のイベントに2つほど参加してました。 GitHubのプロフィールにも同じことを書いてある気がしますが…\nKibo Robot Programming Challenge 4th 略してKRPC4。こちらのイベントです。 ちっこいロボットを動かしてスコアを競っていいく系のイベントです。\n特徴としては、状況がISS中という設定で、無重力(厳密には違いますが…)なので3次元で動かせるのが特徴です。 移動させてレーザーで的あてすることでスコアが稼げるようになって、制限時間内でそのスコアを競っていきます。\n結果としては、全然良くなかったのが残念…\n上位陣の作戦方針が、移動ルートの埋め込みだったんですが、こだわりで逐次ルート計算するのがちょっと良くなかったかな。\nでも埋め込みな大会ってちょっとおもしろくないよねと思ったり\nJP Hacks 2023 去年琉大生のチームが全国行ってましたね。ハッカソンに出てみたいなとか思ってたので、今年は参加してみました。 個人参加です。\nハッカソン自体はチーム対抗なので、事務局が組んでくれたチームに入ることになります。 チームは2人なので、初対面の人とチームを組むことになります。\nちょっとチーム開発感のない開発をしちゃったので反省点が多かったです。 ハッカソンの特徴上、2日間で設計から完成まで持っていかないと行けないので設計が大事なんですが微妙な設計になっちゃって色々変わったりして苦労したり、開発環境をあわせるのがつらいとか、そういうのがありました。\n開発環境をこの2日間のために作って環境を汚すのも嫌なのと、個人的な趣味もあって開発環境はDockerで作ったんですが、メンバーの方のPCが思ったより非力でDockerで開発環境を動かすとまともに開発ができない…という問題がありました。 いつもM1で開発してるとそういったことを忘れちゃうのでだいぶ困っていました。\nおわり 今日の話は技術的な話がぜんぜんなくて申し訳ないのだ。\n12/20頃にもあと一つ書く予定なのでそこではもっと技術的な話をしたいと思います。 ではまた。\n","date":"2023-12-05","permalink":"https://medicine-t.github.io/medicine-t/post/advent2023-4/","tags":["琉大","ie","advent2023"],"title":"誕生日なので今年を振り返ってみる"},{"content":"カルノー図を書きたくてaskmapsパッケージを、図を入れたくてgraphicsを使っていたらなんか図が表示されない…とくにログも出てない…\n結論としてはgraphicsより先にaskmapsを読み込んだら図が表示された。\n\\usepackage{askmaps} \\usepackage[dvipdfmx]{graphicx} ","date":"2023-05-29","permalink":"https://medicine-t.github.io/medicine-t/post/tex-askmaps-graphics/","tags":["tex"],"title":"TexでAskmapsとgraphicsでハマった話"},{"content":"TL;DR 今年(2023)のインストール大会のTAをしたぞ\nB2一人ぼっちだったぞ\n来年が心配だぞ\n本題 今年のインストール大会はﾁｷｭｳｽｸｲﾀｲ人々が集まった。\n大体が(新)B3だった\n相変わらず321のwifiは死亡していたのでやっぱり有線LANを配っていた。来年は始まる前に配ればいいのでは…？(名案)\nあと60人もいれば謎のエラーで死んでる人もポツポツ出ていて、面白いなぁと思ったり\n閑話 MacBookAir(M2)って充電ケーブルが独自のに戻っていたらしい。USB-Cでも給電できるんだろうか。\nUSB-C給電はいいぞ\n閑話休題\n実際インストール大会のTA陣のボリュームゾーンは何年生なんだろう。 B3が活発だからいっぱいいたとすると来年が大変そうだけどな。 来年は大変になるのかならないのかは神の味噌汁。\n","date":"2023-04-14","permalink":"https://medicine-t.github.io/medicine-t/post/install-taikai-2023/","tags":["TA"],"title":"インストール大会2023のTA"},{"content":"人生3度目のサイエンスリーダーはTAとしての参加でした! 受講生の話をまとめたり進めたりするのになれていなくて大変です\n何より会場が無駄に遠い!!琉大でええじゃないか\n一つ言うことがあるとすれば自前のモバイルルーターを持っていくとネットワークまわりのトラブルに悩まされなくて済みます。ただ、恩納村まで行くといくらau回線でもきついので覚悟の準備をしておいてください!\n反省点としては参加者のグループをまとめるのがうまく行かなかったのでグループハンドリングを強くしたいですね。\n","date":"2022-10-10","permalink":"https://medicine-t.github.io/medicine-t/post/science-leader/","tags":["TA","サイエンスリーダー"],"title":"Science LeaderのTAをした話"},{"content":"つい3日ぐらい前にGitHub Pagesを作った。 その時はMarkdownだけでやっていたんだけどテーマをしっかり作りたくなってHugoに移行した\n","date":"2022-09-25","permalink":"https://medicine-t.github.io/medicine-t/post/first/","tags":null,"title":"MD単体からHugoに移行したはなし"}]